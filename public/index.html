<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>匿名視訊聊天室</title>
</head>
<body>
  <h1>Welcome to the Anonymous Video Chat</h1>
  <video id="localVideo" autoplay playsinline muted width="320"></video>
  <video id="remoteVideo" autoplay playsinline width="320"></video>
  <br />
  <button onclick="leaveChat(true)">離開</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    let localStream;
    const peerConnection = new RTCPeerConnection();
    let isInitiator = false;

    async function startChat() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      } catch (err) {
        console.error("getUserMedia error:", err);
      }
    }

    peerConnection.ontrack = event => {
      remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        socket.emit("candidate", event.candidate);
      }
    };

    socket.on("connect", () => {
      startChat();
    });

    socket.on("offer", async ({ from }) => {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit("answer", { offer, to: from });
    });

    socket.on("answer", async ({ offer }) => {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    });

    socket.on("candidate", async (candidate) => {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (err) {
        console.error("ICE candidate error:", err);
      }
    });

    function leaveChat(force = false) {
      if (remoteVideo.srcObject) {
        remoteVideo.srcObject.getTracks().forEach(track => track.stop());
        remoteVideo.srcObject = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      peerConnection.close();
      socket.disconnect();
      if (force) location.reload();
    }
  </script>
</body>
</html>
